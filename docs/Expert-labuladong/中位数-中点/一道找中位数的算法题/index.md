# [啊这，一道找中位数的算法题把东哥整不会了…](https://mp.weixin.qq.com/s/oklQN_xjYy--_fbFkd9wMg)

如果输入一个数组，让你求中位数，这个好办，排个序，如果数组长度是奇数，最中间的一个元素就是中位数，如果数组长度是偶数，最中间两个元素的平均数作为中位数。

如果数据规模非常巨大，排序不太现实，那么也可以使用概率算法，随机抽取一部分数据，排序，求中位数，近似作为所有数据的中位数。

本文说的中位数算法比较困难，也比较精妙，是力扣第 295 题，要求你在数据流中计算中位数：

leetcode [剑指 Offer 41. 数据流中的中位数](https://leetcode-cn.com/problems/shu-ju-liu-zhong-de-zhong-wei-shu-lcof/)

leetcode [295. 数据流的中位数](https://leetcode-cn.com/problems/find-median-from-data-stream/)

> 设计一个支持以下两种操作的数据结构：
>
> `void addNum(int num)` - 从数据流中添加一个整数到数据结构中。
>
> `double findMedian()` - 返回目前所有元素的中位数。

## 尝试分析

> NOTE: 
>
> 1、保证数据的有序，这样求解中位数是非常容易的
>
> 2、"`void addNum(int num)` - 从数据流中添加一个整数到数据结构中"，显然是需要不断地插入的，为了保证有序，需要计算插入的位置

### Array

> NOTE:
>
> 一、array
>
> 优势:
>
> 1、O(1) random access，这样可以直接根据下标access到中位数
>
> 劣势:
>
> 1、插入的时候，需要考虑两个问题: 
>
> a、如何找到插入的位置？二分搜索
>
> b、如何插入？对于array而言，需要做很多的搬移



一个直接的解法可以用一个数组记录所有`addNum`添加进来的数字，通过插入排序的逻辑保证数组中的元素有序，当调用`findMedian`方法时，可以通过数组索引直接计算中位数。

> NOTE: 优势

但是用数组作为底层容器的问题也很明显，`addNum`搜索插入位置的时候可以用二分搜索算法，但是插入操作需要搬移数据，所以最坏时间复杂度为 O(N)。

> NOTE: 劣势



### Linked list

> NOTE: 
>
> 一、优势与劣势
>
> 插入是无需搬移的，但是不支持random access，只能够顺序遍历，显然这是复杂的较高的操作，这对于频繁的插入是不友好的。
>
> 

那换链表？链表插入元素很快，但是查找插入位置的时候只能线性遍历，最坏时间复杂度还是 O(N)，而且`findMedian`方法也需要遍历寻找中间索引，最坏时间复杂度也是 O(N)。



### 平衡二叉搜索树

> NOTE: 
>
> 1、原文用的是"平衡二叉树"，其实是不准确的，应该是"平衡二叉搜索树"，只有这样才能够保持有序



比如用 Java 提供的`TreeSet`容器，底层是红黑树，`addNum`直接插入，`findMedian`可以通过当前元素的个数推出计算中位数的元素的排名。

很遗憾，依然不行，这里有两个问题。

第一，`TreeSet`是一种`Set`，其中不存在重复元素的元素，但是我们的数据流可能输入重复数据的，而且计算中位数也是需要算上重复元素的。

第二，`TreeSet`并没有实现一个通过排名快速计算元素的 API。假设我想找到`TreeSet`中第 5 大的元素，并没有一个现成可用的方法实现这个需求。

> NOTE: 
>
> 1、看了上述内容我想到了C++ `std::map`，它也是red black tree，C++ `std::map`也是不允许重复元素的，并且没有提供rank API，因此， 无法直接使用
>
> 2、另外一个容易忽视的事实是: root node in a red black tree不是中点



PS：如果让你实现一个在二叉搜索树中通过排名计算对应元素的方法`rank(int index)`，你会怎么设计？你可以思考一下，我会把答案写在留言区置顶。

> NOTE: 
>
> 1、参见 `Rank-of-node-in-tree` 章节

### 优先级队列（二叉堆）

除了平衡二叉树，还有没有什么常用的数据结构是动态有序的？优先级队列（二叉堆）行不行？

好像也不太行，因为优先级队列是一种受限的数据结构，只能从堆顶添加/删除元素，我们的`addNum`方法可以从堆顶插入元素，但是`findMedian`函数需要从数据中间取，这个功能优先级队列是没办法提供的。

